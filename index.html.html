<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dermoscopic Hair Annotation Tool</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.875rem;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .hair-type {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .hair-type:hover {
            border-color: #9ca3af;
        }
        
        .hair-type.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .hair-type-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .color-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid;
        }
        
        .slider-container {
            margin-bottom: 16px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-outline {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-outline:hover {
            background: #f9fafb;
        }
        
        .btn-block {
            width: 100%;
            margin-bottom: 12px;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .image-container {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            position: relative;
            overflow: auto;
        }
        
        .placeholder {
            text-align: center;
            color: #6b7280;
        }
        
        .placeholder svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        #canvas {
            max-width: 100%;
            height: auto;
            cursor: crosshair;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            text-align: center;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .stat-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .stat-percentage {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .follicular-stats {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }
        
        .follicular-stats h3 {
            text-align: center;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .follicular-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .follicular-stat {
            text-align: center;
            padding: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        
        .follicular-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .follicular-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .total-badge {
            display: inline-block;
            background: #e5e7eb;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            text-align: center;
            margin-top: 16px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .badge {
            background: #e5e7eb;
            color: #374151;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .follicular-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dermoscopic Hair Annotation Tool</h1>
            <p>Upload and annotate dermoscopic hair images with follicular unit analysis</p>
        </div>
        
        <div class="grid">
            <!-- Left Panel -->
            <div>
                <!-- Patient Data -->
                <div class="card">
                    <h2 class="card-title">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Patient Information
                    </h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="patientName" placeholder="Patient name">
                        </div>
                        <div class="form-group">
                            <label>Age</label>
                            <input type="text" id="patientAge" placeholder="Age">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gender</label>
                            <input type="text" id="patientGender" placeholder="Gender">
                        </div>
                        <div class="form-group">
                            <label>Patient ID</label>
                            <input type="text" id="patientId" placeholder="Patient ID">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Clinical Notes</label>
                        <textarea id="patientNotes" placeholder="Enter clinical notes..."></textarea>
                    </div>
                </div>
                
                <!-- Upload Image -->
                <div class="card">
                    <h2 class="card-title">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Upload Image
                    </h2>
                    <div class="form-group">
                        <input type="file" id="imageUpload" accept="image/*">
                    </div>
                </div>
                
                <!-- Hair Types -->
                <div class="card">
                    <h2 class="card-title">Hair Types</h2>
                    <div class="hair-type" data-type="vellus" data-color="#3B82F6">
                        <div class="hair-type-content">
                            <div class="color-circle" style="background-color: rgba(59, 130, 246, 0.25); border-color: #3B82F6;"></div>
                            <span>Vellus Hair</span>
                        </div>
                    </div>
                    <div class="hair-type" data-type="non-vellus" data-color="#EF4444">
                        <div class="hair-type-content">
                            <div class="color-circle" style="background-color: rgba(239, 68, 68, 0.25); border-color: #EF4444;"></div>
                            <span>Non-Vellus Hair</span>
                        </div>
                    </div>
                    <div class="hair-type" data-type="anagen" data-color="#10B981">
                        <div class="hair-type-content">
                            <div class="color-circle" style="background-color: rgba(16, 185, 129, 0.25); border-color: #10B981;"></div>
                            <span>Anagen Hair</span>
                        </div>
                    </div>
                    <div class="hair-type" data-type="telogen" data-color="#F59E0B">
                        <div class="hair-type-content">
                            <div class="color-circle" style="background-color: rgba(245, 158, 11, 0.25); border-color: #F59E0B;"></div>
                            <span>Telogen Hair</span>
                        </div>
                    </div>
                    <div class="hair-type" data-type="follicular-unit" data-color="#8B5CF6">
                        <div class="hair-type-content">
                            <div class="color-circle" style="background-color: rgba(139, 92, 246, 0.25); border-color: #8B5CF6;"></div>
                            <span>Follicular Unit</span>
                            <span id="follicularBadge" class="badge hidden">1 hairs</span>
                        </div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="card">
                    <h2 class="card-title">Controls</h2>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Zoom Level</span>
                            <span id="zoomValue">1x</span>
                        </div>
                        <input type="range" id="zoomSlider" min="0.5" max="3" step="0.1" value="1">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Annotation Size</span>
                            <span id="sizeValue">10px</span>
                        </div>
                        <input type="range" id="sizeSlider" min="5" max="30" step="2" value="10">
                    </div>
                    <div id="follicularControls" class="slider-container hidden">
                        <div class="slider-label">
                            <span>Hairs per Follicular Unit</span>
                            <span id="hairCountValue">1</span>
                        </div>
                        <input type="range" id="hairCountSlider" min="1" max="8" step="1" value="1">
                    </div>
                    <button id="annotateBtn" class="btn btn-primary btn-block">Start Annotating</button>
                    <div class="btn-group">
                        <button id="undoBtn" class="btn btn-outline" disabled>Undo</button>
                        <button id="clearBtn" class="btn btn-secondary" disabled>Clear All</button>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel -->
            <div>
                <div class="card">
                    <h2 class="card-title">Image Annotation</h2>
                    <div class="image-container" id="imageContainer">
                        <div class="placeholder" id="placeholder">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p>Upload an image to start annotating</p>
                        </div>
                        <canvas id="canvas" style="display: none;"></canvas>
                    </div>
                </div>
                
                <!-- Results Panel -->
                <div id="resultsPanel" class="card hidden">
                    <div class="results-header">
                        <h2 class="card-title">Analysis Results</h2>
                        <div>
                            <button id="downloadImageBtn" class="btn btn-outline" style="margin-right: 8px;">
                                Download Image
                            </button>
                            <button id="downloadReportBtn" class="btn btn-primary">
                                Download Report
                            </button>
                        </div>
                    </div>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class DermoscopicAnnotationTool {
            constructor() {
                this.annotations = [];
                this.selectedType = 'vellus';
                this.selectedColor = '#3B82F6';
                this.isAnnotating = false;
                this.zoom = 1;
                this.circleSize = 10;
                this.hairCount = 1;
                this.image = null;
                this.canvas = null;
                this.ctx = null;
                
                this.init();
            }
            
            init() {
                // Image upload
                document.getElementById('imageUpload').addEventListener('change', (e) => this.handleImageUpload(e));
                
                // Hair type selection
                document.querySelectorAll('.hair-type').forEach(el => {
                    el.addEventListener('click', (e) => this.selectHairType(e));
                });
                
                // Controls
                document.getElementById('zoomSlider').addEventListener('input', (e) => this.updateZoom(e));
                document.getElementById('sizeSlider').addEventListener('input', (e) => this.updateSize(e));
                document.getElementById('hairCountSlider').addEventListener('input', (e) => this.updateHairCount(e));
                document.getElementById('annotateBtn').addEventListener('click', () => this.toggleAnnotating());
                document.getElementById('undoBtn').addEventListener('click', () => this.undoLastAnnotation());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAllAnnotations());
                
                // Download buttons
                document.getElementById('downloadImageBtn').addEventListener('click', () => this.downloadAnnotatedImage());
                document.getElementById('downloadReportBtn').addEventListener('click', () => this.downloadReport());
                
                // Canvas click
                document.getElementById('canvas').addEventListener('click', (e) => this.handleCanvasClick(e));
                
                // Select first hair type by default
                document.querySelector('.hair-type').click();
            }
            
            handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    this.image = new Image();
                    this.image.onload = () => {
                        this.setupCanvas();
                        this.clearAllAnnotations();
                    };
                    this.image.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            setupCanvas() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                // Set canvas size to match image
                this.canvas.width = this.image.width;
                this.canvas.height = this.image.height;
                
                // Show canvas, hide placeholder
                document.getElementById('placeholder').style.display = 'none';
                this.canvas.style.display = 'block';
                
                this.drawImage();
            }
            
            drawImage() {
                if (!this.canvas || !this.image) return;
                
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.drawImage(this.image, 0, 0, this.canvas.width, this.canvas.height);
                
                // Draw annotations
                this.annotations.forEach(annotation => {
                    this.drawAnnotation(annotation);
                });
                
                // Draw results overlay
                this.drawResultsOverlay();
            }
            
            drawAnnotation(annotation) {
                const { x, y, type, color, hairCount, size } = annotation;
                
                // Draw circle
                this.ctx.beginPath();
                this.ctx.arc(x, y, size, 0, 2 * Math.PI);
                this.ctx.strokeStyle = color;
                this.ctx.lineWidth = 3;
                this.ctx.stroke();
                
                // Add semi-transparent fill
                this.ctx.fillStyle = color + '40';
                this.ctx.fill();
                
                // Add hair count text for follicular units
                if (type === 'follicular-unit' && hairCount) {
                    this.ctx.font = 'bold 12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillStyle = 'white';
                    this.ctx.strokeStyle = 'black';
                    this.ctx.lineWidth = 3;
                    this.ctx.strokeText(hairCount.toString(), x, y);
                    this.ctx.fillText(hairCount.toString(), x, y);
                }
            }
            
            drawResultsOverlay() {
                if (this.annotations.length === 0) return;
                
                const stats = this.calculateStats();
                const total = this.annotations.length;
                
                // Set up text styling
                this.ctx.font = 'bold 16px Arial';
                this.ctx.textAlign = 'left';
                this.ctx.textBaseline = 'top';
                
                // Create text lines
                const textLines = [`Total: ${total}`];
                
                Object.entries(stats).forEach(([type, { count, percentage }]) => {
                    if (type === 'follicular-stats') return;
                    const labels = {
                        'vellus': 'Vellus',
                        'non-vellus': 'Non-Vellus',
                        'anagen': 'Anagen',
                        'telogen': 'Telogen',
                        'follicular-unit': 'FU'
                    };
                    const label = labels[type] || type;
                    textLines.push(`${label}: ${count} (${percentage}%)`);
                });
                
                // Add follicular stats if present
                if (stats['follicular-stats']) {
                    textLines.push(`Avg/FU: ${stats['follicular-stats'].count}`);
                }
                
                // Calculate background size
                const lineHeight = 20;
                const padding = 10;
                const textWidth = Math.max(...textLines.map(line => this.ctx.measureText(line).width));
                const boxHeight = textLines.length * lineHeight + padding * 2;
                const boxWidth = textWidth + padding * 2;
                
                // Draw background
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                this.ctx.fillRect(10, 10, boxWidth, boxHeight);
                
                // Draw text
                this.ctx.fillStyle = 'white';
                textLines.forEach((line, index) => {
                    this.ctx.fillText(line, 10 + padding, 10 + padding + index * lineHeight);
                });
            }
            
            selectHairType(e) {
                // Remove previous selection
                document.querySelectorAll('.hair-type').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Add selection to clicked element
                const element = e.currentTarget;
                element.classList.add('selected');
                this.selectedType = element.dataset.type;
                this.selectedColor = element.dataset.color;
                
                // Show/hide follicular controls
                const follicularControls = document.getElementById('follicularControls');
                const follicularBadge = document.getElementById('follicularBadge');
                if (this.selectedType === 'follicular-unit') {
                    follicularControls.classList.remove('hidden');
                    follicularBadge.classList.remove('hidden');
                    follicularBadge.textContent = `${this.hairCount} hairs`;
                } else {
                    follicularControls.classList.add('hidden');
                    follicularBadge.classList.add('hidden');
                }
            }
            
            updateZoom(e) {
                this.zoom = parseFloat(e.target.value);
                document.getElementById('zoomValue').textContent = this.zoom + 'x';
                this.canvas.style.transform = `scale(${this.zoom})`;
                this.canvas.style.transformOrigin = 'top left';
            }
            
            updateSize(e) {
                this.circleSize = parseInt(e.target.value);
                document.getElementById('sizeValue').textContent = this.circleSize + 'px';
                this.drawImage();
            }
            
            updateHairCount(e) {
                this.hairCount = parseInt(e.target.value);
                document.getElementById('hairCountValue').textContent = this.hairCount;
                document.getElementById('follicularBadge').textContent = `${this.hairCount} hairs`;
            }
            
            toggleAnnotating() {
                this.isAnnotating = !this.isAnnotating;
                const btn = document.getElementById('annotateBtn');
                btn.textContent = this.isAnnotating ? 'Stop Annotating' : 'Start Annotating';
                btn.className = this.isAnnotating ? 'btn btn-danger btn-block' : 'btn btn-primary btn-block';
                this.canvas.style.cursor = this.isAnnotating ? 'crosshair' : 'default';
            }
            
            handleCanvasClick(e) {
                if (!this.isAnnotating || !this.canvas) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const scaleX = this.canvas.width / rect.width;
                const scaleY = this.canvas.height / rect.height;
                
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                
                const annotation = {
                    id: Date.now().toString(),
                    x, y,
                    type: this.selectedType,
                    color: this.selectedColor,
                    size: this.circleSize,
                    hairCount: this.selectedType === 'follicular-unit' ? this.hairCount : undefined
                };
                
                this.annotations.push(annotation);
                this.drawImage();
                this.updateResults();
                this.updateButtons();
            }
            
            undoLastAnnotation() {
                if (this.annotations.length > 0) {
                    this.annotations.pop();
                    this.drawImage();
                    this.updateResults();
                    this.updateButtons();
                }
            }
            
            clearAllAnnotations() {
                this.annotations = [];
                if (this.canvas) {
                    this.drawImage();
                }
                this.updateResults();
                this.updateButtons();
            }
            
            updateButtons() {
                const hasAnnotations = this.annotations.length > 0;
                document.getElementById('undoBtn').disabled = !hasAnnotations;
                document.getElementById('clearBtn').disabled = !hasAnnotations;
            }
            
            calculateStats() {
                const total = this.annotations.length;
                if (total === 0) return {};
                
                const stats = {};
                const types = ['vellus', 'non-vellus', 'anagen', 'telogen', 'follicular-unit'];
                
                types.forEach(type => {
                    const count = this.annotations.filter(a => a.type === type).length;
                    stats[type] = {
                        count,
                        percentage: Math.round((count / total) * 100)
                    };
                });
                
                // Calculate follicular unit statistics
                const follicularUnits = this.annotations.filter(a => a.type === 'follicular-unit');
                if (follicularUnits.length > 0) {
                    const totalHairs = follicularUnits.reduce((sum, unit) => sum + (unit.hairCount || 1), 0);
                    const avgHairs = totalHairs / follicularUnits.length;
                    
                    stats['follicular-stats'] = {
                        count: Math.round(avgHairs * 10) / 10,
                        percentage: follicularUnits.length
                    };
                }
                
                return stats;
            }
            
            updateResults() {
                const stats = this.calculateStats();
                const total = this.annotations.length;
                
                if (total === 0) {
                    document.getElementById('resultsPanel').classList.add('hidden');
                    return;
                }
                
                document.getElementById('resultsPanel').classList.remove('hidden');
                
                const labels = {
                    'vellus': 'Vellus Hair',
                    'non-vellus': 'Non-Vellus Hair',
                    'anagen': 'Anagen Hair',
                    'telogen': 'Telogen Hair',
                    'follicular-unit': 'Follicular Unit'
                };
                
                const colors = {
                    'vellus': '#3B82F6',
                    'non-vellus': '#EF4444',
                    'anagen': '#10B981',
                    'telogen': '#F59E0B',
                    'follicular-unit': '#8B5CF6'
                };
                
                let html = '<div class="results-grid">';
                
                // Add regular hair type stats
                Object.entries(stats).forEach(([type, { count, percentage }]) => {
                    if (type === 'follicular-stats') return;
                    
                    html += `
                        <div class="stat-card">
                            <div class="stat-label">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${colors[type]};"></div>
                                <span>${labels[type]}</span>
                            </div>
                            <div class="stat-value">${count}</div>
                            <div class="stat-percentage">${percentage}%</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Add follicular unit analysis if present
                if (stats['follicular-stats']) {
                    const follicularUnits = this.annotations.filter(a => a.type === 'follicular-unit');
                    const totalHairs = follicularUnits.reduce((sum, unit) => sum + (unit.hairCount || 1), 0);
                    
                    html += `
                        <div class="follicular-stats">
                            <h3>Follicular Unit Analysis</h3>
                            <div class="follicular-grid">
                                <div class="follicular-stat">
                                    <div class="follicular-label">Units Counted</div>
                                    <div class="follicular-value">${stats['follicular-stats'].percentage}</div>
                                </div>
                                <div class="follicular-stat">
                                    <div class="follicular-label">Avg Hairs/Unit</div>
                                    <div class="follicular-value">${stats['follicular-stats'].count}</div>
                                </div>
                                <div class="follicular-stat">
                                    <div class="follicular-label">Total Hairs</div>
                                    <div class="follicular-value">${totalHairs}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `<div class="total-badge">Total Annotations: ${total}</div>`;
                
                document.getElementById('resultsContent').innerHTML = html;
            }
            
            downloadAnnotatedImage() {
                if (!this.canvas) return;
                
                const link = document.createElement('a');
                link.download = 'annotated-image.png';
                link.href = this.canvas.toDataURL();
                link.click();
            }
            
            downloadReport() {
                const stats = this.calculateStats();
                const total = this.annotations.length;
                
                // Get patient data
                const patientData = {
                    name: document.getElementById('patientName').value,
                    age: document.getElementById('patientAge').value,
                    gender: document.getElementById('patientGender').value,
                    id: document.getElementById('patientId').value,
                    notes: document.getElementById('patientNotes').value
                };
                
                let report = 'Dermoscopic Hair Analysis Report\n';
                report += '================================\n\n';
                
                // Add patient information
                report += 'Patient Information\n';
                report += '------------------\n';
                if (patientData.name) report += `Name: ${patientData.name}\n`;
                if (patientData.age) report += `Age: ${patientData.age}\n`;
                if (patientData.gender) report += `Gender: ${patientData.gender}\n`;
                if (patientData.id) report += `Patient ID: ${patientData.id}\n`;
                report += '\n';
                
                if (patientData.notes) {
                    report += 'Clinical Notes\n';
                    report += '--------------\n';
                    report += `${patientData.notes}\n\n`;
                }
                
                report += 'Analysis Results\n';
                report += '----------------\n';
                report += `Total Annotations: ${total}\n\n`;
                
                // Only include hair types that have been annotated
                const annotatedTypes = Object.entries(stats).filter(([key, stat]) => {
                    if (key === 'follicular-stats') return false;
                    return stat.count > 0;
                });
                
                if (annotatedTypes.length === 0) {
                    report += 'No annotations recorded.\n';
                } else {
                    const reportLabels = {
                        'vellus': 'Vellus Hair',
                        'non-vellus': 'Non-Vellus Hair',
                        'anagen': 'Anagen Hair',
                        'telogen': 'Telogen Hair',
                        'follicular-unit': 'Follicular Unit'
                    };
                    
                    annotatedTypes.forEach(([type, { count, percentage }]) => {
                        report += `${reportLabels[type]}:\n`;
                        report += `  Count: ${count}\n`;
                        report += `  Percentage: ${percentage}%\n\n`;
                    });
                }
                
                // Add follicular unit analysis if present
                const follicularStats = stats['follicular-stats'];
                if (follicularStats) {
                    const follicularUnits = this.annotations.filter(a => a.type === 'follicular-unit');
                    const totalHairsInFollicles = follicularUnits.reduce((sum, unit) => sum + (unit.hairCount || 1), 0);
                    
                    report += 'Follicular Unit Analysis\n';
                    report += '-----------------------\n';
                    report += `Follicular Units Counted: ${follicularStats.percentage}\n`;
                    report += `Total Hairs in Follicles: ${totalHairsInFollicles}\n`;
                    report += `Average Hairs per Follicle: ${follicularStats.count}\n\n`;
                    
                    // Add detailed breakdown
                    report += 'Hair Count Distribution:\n';
                    const distribution = {};
                    follicularUnits.forEach(unit => {
                        const count = unit.hairCount || 1;
                        distribution[count] = (distribution[count] || 0) + 1;
                    });
                    
                    Object.entries(distribution).sort(([a], [b]) => parseInt(a) - parseInt(b)).forEach(([count, units]) => {
                        report += `  ${count} hair${parseInt(count) > 1 ? 's' : ''}: ${units} unit${units > 1 ? 's' : ''}\n`;
                    });
                }
                
                report += '\nGenerated on: ' + new Date().toLocaleString();
                
                const blob = new Blob([report], { type: 'text/plain' });
                const link = document.createElement('a');
                link.download = `hair-analysis-report-${patientData.name || 'patient'}-${Date.now()}.txt`;
                link.href = URL.createObjectURL(blob);
                link.click();
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new DermoscopicAnnotationTool();
        });
    </script>
</body>
</html>